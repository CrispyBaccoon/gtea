#!/usr/bin/env sh

gtea__workflow_usage() {
>&2 cat <<"EOF"
   [update]  -  update local feature branch to changes from [master|<branch>]
     [push]  -  push local feature branch to master
EOF
return 1
}

gtea__workflow_main() {
  [ "$1" ] || gtea__workflow_usage
  [[ -f .gtea ]] ||gtea__die 'no `.gtea` workflow file found in the root directory'

  flag=${1#-}
  shift

  case $flag in
    update) gtea__wf_update $@ ;;
      push) gtea__wf_push $@ ;;
    *)gtea__die "command does not exist" ;;
  esac
}

gtea__wf_update() {
  # stash local changes
  local_changes=false
  [[ -z "$(git diff)" ]] || local_changes=true
  $local_changes && git stash --all -u

  # rebase on to master
  master="$(cat .gtea | jq '.master' | tr -d '"')"
  [[ -z "$master" ]] &&gtea__die 'no master branch defined.'
  ahead="$master"
  [[ -z "$1" ]] || ahead="$1"
  git rebase $master

  # apply local changes
  $local_changes && git stash pop -q
}

gtea__wf_push() {
  branch="$(git branch --show-current)"

  # change dir to master
  master="$(cat .gtea | jq '.master' | tr -d '"')"
  [[ -z "$master" ]] &&gtea__die 'no master branch defined.'
  dir=$(git worktree list --porcelain | grep -E 'worktree ' | awk '/'"$(echo "$master" | sed 's/\//./g')"'/ {print; exit}' | cut -d ' ' -f2-)
  cd "$dir"

  # rebase on to local branch
  gtea__wf_update "$branch"

  gtea__push && popd
}
